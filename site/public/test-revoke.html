<!DOCTYPE html>
<html>
<head>
  <title>Test Revoke (Exact Dashboard Code)</title>
  <style>
    body { background: #0a0a0a; color: #fff; font-family: monospace; padding: 20px; }
    pre { background: #1a1a1a; padding: 15px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; }
    button { background: #3b82f6; color: white; border: none; padding: 10px 20px; 
             border-radius: 6px; cursor: pointer; margin: 5px; }
    button:hover { background: #2563eb; }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    input { background: #1a1a1a; color: white; border: 1px solid #333; 
            padding: 8px; border-radius: 4px; width: 300px; }
  </style>
</head>
<body>
  <h1>Test Machine Revoke (Uses Exact Dashboard Code)</h1>
  
  <div style="margin-bottom: 20px;">
    <label>Machine ID: </label>
    <input type="text" id="machineId" placeholder="Enter machine ID from dashboard" />
    <button onclick="testRevoke()">Revoke Machine</button>
  </div>
  
  <div id="output"></div>

  <script>
    const API_BASE = 'https://api.pyro1121.com';
    
    const log = (msg, isError = false) => {
      const div = document.createElement('div');
      div.className = isError ? 'error' : 'success';
      div.innerHTML = '<pre>' + JSON.stringify(msg, null, 2) + '</pre>';
      document.getElementById('output').appendChild(div);
    };

    // EXACT copy of apiRequest from site/src/lib/api.ts
    async function apiRequest(endpoint, options = {}) {
      const token = localStorage.getItem('omg_session_token');

      const headers = {
        'Content-Type': 'application/json',
        ...(options.headers || {}),
      };

      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }

      log({ 
        action: 'Sending request',
        url: `${API_BASE}${endpoint}`,
        method: options.method || 'GET',
        headers,
        body: options.body 
      });

      const response = await fetch(`${API_BASE}${endpoint}`, {
        ...options,
        headers,
      });

      const data = await response.json();

      log({
        action: 'Received response',
        status: response.status,
        statusText: response.statusText,
        ok: response.ok,
        data
      }, !response.ok);

      return data;
    }

    // EXACT copy of revokeMachine from site/src/lib/api.ts
    async function revokeMachine(machineId) {
      return apiRequest('/api/machines/revoke', {
        method: 'POST',
        body: JSON.stringify({ machine_id: machineId }),
      });
    }

    async function testRevoke() {
      const machineId = document.getElementById('machineId').value;
      
      if (!machineId) {
        log({ error: 'Please enter a machine ID' }, true);
        return;
      }

      const token = localStorage.getItem('omg_session_token');
      if (!token) {
        log({ error: 'No session token found. Please log in to dashboard first.' }, true);
        return;
      }

      log({ action: 'Starting revoke', machineId });

      try {
        const result = await revokeMachine(machineId);
        log({ action: 'Success!', result });
      } catch (e) {
        log({ action: 'Error caught', error: e.message, stack: e.stack }, true);
      }
    }
  </script>
</body>
</html>
