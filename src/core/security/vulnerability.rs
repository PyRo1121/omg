use anyhow::{Context, Result};
use serde::{Deserialize, Serialize};

#[derive(Debug, Serialize)]
struct OsvRequest {
    package: OsvPackage,
    version: String,
}

#[derive(Debug, Serialize)]
struct OsvPackage {
    name: String,
    ecosystem: String,
}

#[derive(Debug, Deserialize)]
struct OsvResponse {
    vulns: Option<Vec<DetailedVulnerability>>,
}

#[derive(Debug, Deserialize)]
pub struct DetailedVulnerability {
    pub id: String,
    pub summary: Option<String>,
    pub details: Option<String>,
    pub severity: Option<Vec<Severity>>,
}

#[derive(Debug, Deserialize)]
pub struct Severity {
    #[serde(rename = "type")]
    pub severity_type: String,
    pub score: String,
}

#[derive(Debug, Clone)]
pub struct VulnerabilityReport {
    pub id: String,
    pub summary: String,
    pub score: Option<String>,
}

/// Vulnerability scanner using OSV/CVE database
pub struct VulnerabilityScanner {
    client: reqwest::Client,
}

impl VulnerabilityScanner {
    pub fn new() -> Self {
        Self {
            client: reqwest::Client::new(),
        }
    }

    /// Scan a package against the OSV database
    pub async fn scan_package(
        &self,
        name: &str,
        version: &str,
    ) -> Result<Vec<VulnerabilityReport>> {
        let request = OsvRequest {
            package: OsvPackage {
                name: name.to_string(),
                ecosystem: "Arch Linux".to_string(),
            },
            version: version.to_string(),
        };

        let response: OsvResponse = self
            .client
            .post("https://api.osv.dev/v1/query")
            .json(&request)
            .send()
            .await?
            .json()
            .await
            .context("Failed to parse OSV response")?;

        let mut reports = Vec::new();
        if let Some(vulns) = response.vulns {
            for vuln in vulns {
                let score = vuln
                    .severity
                    .as_ref()
                    .and_then(|s| s.first())
                    .map(|s| s.score.clone());

                reports.push(VulnerabilityReport {
                    id: vuln.id,
                    summary: vuln
                        .summary
                        .unwrap_or_else(|| "No summary provided".to_string()),
                    score,
                });
            }
        }

        Ok(reports)
    }
}
