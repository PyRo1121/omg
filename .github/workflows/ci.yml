name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. QUALITY & SECURITY GATES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  lint:
    name: "Qual & Sec"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Formatting
        run: cargo fmt --all -- --check

      - name: Mock Enterprise License
        run: |
          mkdir -p ~/.local/share/omg
          echo '{"key":"CI-MOCK-KEY","tier":"enterprise","features":["sbom","audit","secrets","slsa","policy"],"validated_at":9999999999}' > ~/.local/share/omg/license.json

      - name: Clippy (Core)
        run: cargo clippy --all-targets --no-default-features --features debian -- -D warnings -W clippy::pedantic
      
      - name: Spell Check
        uses: crate-ci/typos@master
        with:
          config: ./_typos.toml

      - name: Security Audit (cargo-deny)
        uses: EmbarkStudios/cargo-deny-action@v2
        with:
          command: check
          arguments: --no-default-features --features debian

      - name: Unsafe Code Audit (cargo-geiger)
        continue-on-error: true
        run: |
          cargo install cargo-geiger --locked
          cargo geiger --all-targets --features arch --output-format github

      - name: Binary Size Monitor (cargo-bloat)
        run: |
          cargo install cargo-bloat --locked
          cargo bloat --release --features arch -n 20

      - name: Unused Dependencies
        continue-on-error: true
        run: |
          curl -fsSL https://github.com/bnjbvr/cargo-machete/releases/latest/download/cargo-machete-x86_64-unknown-linux-musl.tar.gz | tar xz
          chmod +x cargo-machete
          ./cargo-machete || echo "Unused dependencies found (advisory)"

  container-scan:
    name: "Container Scan"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Scan Dockerfile (Debian)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          hide-progress: false
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

  coverage:
    name: "Coverage"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      
      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin --locked

      - name: Generate Coverage
        run: |
          cargo tarpaulin --verbose --workspace --timeout 120 --out Xml --fail-under 80 --no-default-features --features debian-pure

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. ARCH LINUX (Full System Integration)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  arch:
    name: "Arch (Full)"
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Bootstrap System
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rust cargo pkgconf openssl libarchive clang
      
      - uses: actions/checkout@v4
      - name: Git Ownership fix
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Rust Version
        id: rust-version
        run: echo "version=$(rustc --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: arch-${{ steps.rust-version.outputs.version }}-${{ hashFiles('Cargo.lock') }}
          restore-keys: arch-${{ steps.rust-version.outputs.version }}-

      - name: Build
        run: cargo build --release --features arch

      - name: Sync Databases
        run: ./target/release/omg sync

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings -W clippy::pedantic

      - name: Run Integration Tests
        run: |
          OMG_RUN_SYSTEM_TESTS=1 cargo test --test integration_suite --features arch
          cargo test --test exhaustive_cli_matrix --features arch

      - name: Generate SBOM (CycloneDX)
        run: |
          cargo install cargo-cyclonedx --locked
          cargo cyclonedx --format json --output-pattern "bom.{format}" --features arch
          
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-arch
          path: "*.bom.json"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3. COMPATIBILITY (Debian/Ubuntu)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  debian:
    name: "Debian Build"
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
      options: --user root
    env:
      HOME: /root
      CARGO_HOME: /root/.cargo
    steps:
      - name: Install Dependencies
        run: |
          apt-get update
          apt-get install -y curl git build-essential pkg-config libssl-dev libapt-pkg-dev clang cmake
          rm -rf /var/lib/apt/lists/*
      
      - uses: actions/checkout@v4
      - name: Git Ownership fix
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Install Rust
        run: |
          curl -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --profile minimal --component clippy,rustfmt
          echo "/root/.cargo/bin" >> $GITHUB_PATH

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            /root/.cargo/registry
            /root/.cargo/git
            target
          key: debian-${{ hashFiles('Cargo.lock') }}
          restore-keys: debian-

      - name: Build & Test
        run: |
          . /root/.cargo/env
          cargo build --release --no-default-features --features debian
          cargo clippy --all-targets --no-default-features --features debian -- -D warnings -W clippy::pedantic
          cargo test --no-default-features --features debian --lib
          cargo test --test exhaustive_cli_matrix --no-default-features --features debian

      - name: Smoke Test
        run: |
          . /root/.cargo/env
          OMG="./target/release/omg"
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  OMG Debian Smoke Tests - All Commands"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo "\n[1/8] omg sync (database refresh)..."
          $OMG sync
          
          echo "\n[2/8] omg search vim..."
          $OMG search vim | head -5
          
          echo "\n[3/8] omg info curl..."
          $OMG info curl
          
          echo "\n[4/8] omg status..."
          $OMG status
          
          echo "\n[5/8] omg explicit --count..."
          $OMG explicit --count
          
          echo "\n[6/8] omg update --check..."
          $OMG update --check || echo "(no updates or check failed - ok)"
          
          echo "\n[7/8] omg install cowsay -y..."
          $OMG install cowsay -y
          
          echo "\n[8/8] omg remove cowsay -y..."
          $OMG remove cowsay || echo "(remove test - ok)"
          
          echo "\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ“ All Debian smoke tests passed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  ubuntu:
    name: "Ubuntu Build"
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y libapt-pkg-dev pkg-config libssl-dev clang cmake
      
      - uses: dtolnay/rust-toolchain@stable
      
      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ubuntu-${{ hashFiles('Cargo.lock') }}
          restore-keys: ubuntu-

      - name: Build & Test
        run: |
          cargo build --release --no-default-features --features debian
          cargo clippy --all-targets --no-default-features --features debian -- -D warnings -W clippy::pedantic
          cargo test --no-default-features --features debian --lib
          cargo test --test exhaustive_cli_matrix --no-default-features --features debian

      - name: Smoke Test
        run: |
          OMG="./target/release/omg"
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  OMG Ubuntu Smoke Tests - All Commands"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo "\n[1/8] omg sync (database refresh)..."
          $OMG sync
          
          echo "\n[2/8] omg search vim..."
          $OMG search vim | head -5
          
          echo "\n[3/8] omg info curl..."
          $OMG info curl
          
          echo "\n[4/8] omg status..."
          $OMG status
          
          echo "\n[5/8] omg explicit --count..."
          $OMG explicit --count
          
          echo "\n[6/8] omg update --check..."
          $OMG update --check || echo "(no updates or check failed - ok)"
          
          echo "\n[7/8] omg install cowsay -y..."
          sudo $OMG install cowsay -y
          
          echo "\n[8/8] omg remove cowsay..."
          sudo $OMG remove cowsay || echo "(remove test - ok)"
          
          echo "\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ“ All Ubuntu smoke tests passed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 4. DOCUMENTATION SYNC
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docs:
    name: "Docs Sync"
    runs-on: ubuntu-latest
    needs: [lint, arch, debian, ubuntu]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Sync to Wiki
        continue-on-error: true
        run: |
          chmod +x scripts/sync-wiki.sh
          ./scripts/sync-wiki.sh || echo "Wiki sync failed (wiki may not exist)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 5. FINAL GATE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ci-success:
    name: "âœ… CI"
    runs-on: ubuntu-latest
    needs: [lint, container-scan, coverage, arch, debian, ubuntu]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "ğŸ” Checking job results..."
          echo "  lint:           ${{ needs.lint.result }}"
          echo "  container-scan: ${{ needs.container-scan.result }}"
          echo "  coverage:       ${{ needs.coverage.result }}"
          echo "  arch:           ${{ needs.arch.result }}"
          echo "  debian:         ${{ needs.debian.result }}"
          echo "  ubuntu:         ${{ needs.ubuntu.result }}"
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.container-scan.result }}" != "success" ]] || \
             [[ "${{ needs.coverage.result }}" != "success" ]] || \
             [[ "${{ needs.arch.result }}" != "success" ]] || \
             [[ "${{ needs.debian.result }}" != "success" ]] || \
             [[ "${{ needs.ubuntu.result }}" != "success" ]]; then
            echo "âŒ One or more jobs failed"
            exit 1
          fi
          echo "âœ… All jobs passed!"
