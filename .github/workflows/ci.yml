name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  # ════════════════════════════════════════════════════════════════════════════
  # QUICK CHECKS
  # ════════════════════════════════════════════════════════════════════════════

  lint:
    name: "Lint & Format"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - run: cargo fmt --all -- --check
      - uses: crate-ci/typos@master
        with:
          config: ./_typos.toml

  # ════════════════════════════════════════════════════════════════════════════
  # ARCH LINUX BUILD & TEST
  # ════════════════════════════════════════════════════════════════════════════

  arch:
    name: "Arch Linux"
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rust cargo pkgconf openssl libarchive clang

      - uses: actions/checkout@v4

      - name: Git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: arch-${{ hashFiles('Cargo.lock') }}
          restore-keys: arch-

      - name: Build
        run: cargo build --release

      - name: Clippy
        run: cargo clippy --all-targets -- -D warnings

      - name: Test
        run: cargo test --lib

  # ════════════════════════════════════════════════════════════════════════════
  # DEBIAN BUILD & TEST
  # ════════════════════════════════════════════════════════════════════════════

  debian:
    name: "Debian 12"
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
      options: --user root
    env:
      HOME: /root
      CARGO_HOME: /root/.cargo
    steps:
      - name: Install Dependencies
        run: |
          apt-get update
          apt-get install -y curl git build-essential pkg-config libssl-dev libapt-pkg-dev clang cmake
          rm -rf /var/lib/apt/lists/*

      - uses: actions/checkout@v4

      - name: Git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Install Rust
        run: |
          curl -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --profile minimal
          echo "/root/.cargo/bin" >> $GITHUB_PATH

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            /root/.cargo/registry
            /root/.cargo/git
            target
          key: debian-${{ hashFiles('Cargo.lock') }}
          restore-keys: debian-

      - name: Build
        run: |
          . /root/.cargo/env
          cargo build --release --no-default-features --features debian

      - name: Test
        run: |
          . /root/.cargo/env
          cargo test --no-default-features --features debian --lib

  # ════════════════════════════════════════════════════════════════════════════
  # UBUNTU BUILD & TEST (native - fastest)
  # ════════════════════════════════════════════════════════════════════════════

  ubuntu:
    name: "Ubuntu 24.04"
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y libapt-pkg-dev pkg-config libssl-dev clang cmake

      - uses: dtolnay/rust-toolchain@stable

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ubuntu-${{ hashFiles('Cargo.lock') }}
          restore-keys: ubuntu-

      - name: Build
        run: cargo build --release --no-default-features --features debian

      - name: Test
        run: cargo test --no-default-features --features debian --lib

  # ════════════════════════════════════════════════════════════════════════════
  # REQUIRED STATUS CHECK
  # ════════════════════════════════════════════════════════════════════════════

  ci:
    name: CI
    runs-on: ubuntu-latest
    needs: [lint, arch, debian, ubuntu]
    if: always()
    steps:
      - name: Check Results
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.arch.result }}" != "success" ]] || \
             [[ "${{ needs.debian.result }}" != "success" ]] || \
             [[ "${{ needs.ubuntu.result }}" != "success" ]]; then
            echo "❌ CI failed"
            exit 1
          fi
          echo "✅ All checks passed!"
