name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  # Feature flags for each platform
  ARCH_FEATURES: arch,pgp,license
  DEBIAN_FEATURES: debian

jobs:
  ################################################################################
  # Lint and formatting checks (runs on all platforms with available features)
  ################################################################################
  lint:
    name: "Lint & Format"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: lint-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: lint-cargo-registry-

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy (arch features only - works everywhere)
        run: |
          cargo clippy --all-targets --features ${{ env.ARCH_FEATURES }} -- -D warnings -W clippy::pedantic

      - name: Run tests (arch features)
        run: cargo test --all-targets --features ${{ env.ARCH_FEATURES }}

  ################################################################################
  # Arch Linux build
  ################################################################################
  arch:
    name: "Arch Linux"
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Install system dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm \
            base-devel \
            git \
            rust \
            cargo \
            pkgconf \
            openssl \
            libarchive \
            clang \
            cmake

      - uses: actions/checkout@v4

      - name: Fix git permissions
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Get rust version
        id: rust-version
        run: echo "version=$(rustc --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: arch-${{ steps.rust-version.outputs.version }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            arch-${{ steps.rust-version.outputs.version }}-
            arch-

      - name: Build release binary
        run: cargo build --release --features ${{ env.ARCH_FEATURES }}

      - name: Run clippy
        run: cargo clippy --all-targets --features ${{ env.ARCH_FEATURES }} -- -D warnings -W clippy::pedantic

      - name: Run unit tests
        run: cargo test --lib --features ${{ env.ARCH_FEATURES }}

      - name: Verify binary exists and works
        run: |
          ./target/release/omg --version
          ./target/release/omg --help

  ################################################################################
  # Debian build
  ################################################################################
  debian:
    name: "Debian"
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm

    env:
      DEBIAN_FRONTEND: noninteractive
      CARGO_HOME: /usr/local/cargo
      RUSTUP_HOME: /usr/local/rustup

    steps:
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates \
            curl \
            git \
            build-essential \
            pkg-config \
            libssl-dev \
            libapt-pkg-dev \
            clang \
            cmake \
            zlib1g-dev \
            liblzma-dev \
            libbz2-dev
          rm -rf /var/lib/apt/lists/*

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          echo 'export PATH="$CARGO_HOME/bin:$PATH"' >> $GITHUB_ENV
          echo 'export RUSTUP_HOME="$RUSTUP_HOME"' >> $GITHUB_ENV

      - uses: actions/checkout@v4

      - name: Fix git permissions
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Get rust version
        id: rust-version
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          echo "version=$(rustc --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: debian-${{ steps.rust-version.outputs.version }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            debian-${{ steps.rust-version.outputs.version }}-
            debian-

      - name: Build release binary
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          cargo build --release --no-default-features --features ${{ env.DEBIAN_FEATURES }}

      - name: Run clippy
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          cargo clippy --all-targets --no-default-features --features ${{ env.DEBIAN_FEATURES }} -- -D warnings -W clippy::pedantic

      - name: Run unit tests
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          cargo test --lib --no-default-features --features ${{ env.DEBIAN_FEATURES }}

      - name: Verify binary exists and works
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          ./target/release/omg --version
          ./target/release/omg --help

  ################################################################################
  # Ubuntu build
  ################################################################################
  ubuntu:
    name: "Ubuntu"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libapt-pkg-dev \
            pkg-config \
            libssl-dev \
            clang \
            cmake

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Get rust version
        id: rust-version
        run: echo "version=$(rustc --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ubuntu-${{ steps.rust-version.outputs.version }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ubuntu-${{ steps.rust-version.outputs.version }}-
            ubuntu-

      - name: Build release binary
        run: cargo build --release --no-default-features --features ${{ env.DEBIAN_FEATURES }}

      - name: Run clippy
        run: cargo clippy --all-targets --no-default-features --features ${{ env.DEBIAN_FEATURES }} -- -D warnings -W clippy::pedantic

      - name: Run unit tests
        run: cargo test --lib --no-default-features --features ${{ env.DEBIAN_FEATURES }}

      - name: Verify binary exists and works
        run: |
          ./target/release/omg --version
          ./target/release/omg --help

  ################################################################################
  # Success check
  ################################################################################
  check-success:
    name: "CI Status"
    runs-on: ubuntu-latest
    needs: [lint, arch, debian, ubuntu]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Arch: ${{ needs.arch.result }}"
          echo "Debian: ${{ needs.debian.result }}"
          echo "Ubuntu: ${{ needs.ubuntu.result }}"

          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.arch.result }}" != "success" ]] || \
             [[ "${{ needs.debian.result }}" != "success" ]] || \
             [[ "${{ needs.ubuntu.result }}" != "success" ]]; then
            echo "::error::One or more jobs failed"
            exit 1
          fi

          echo "::notice::All CI jobs passed successfully!"
