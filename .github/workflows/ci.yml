name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs on new commits to same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10
  # Feature flags for each platform
  ARCH_FEATURES: arch,pgp,license
  DEBIAN_FEATURES: debian

jobs:
  ################################################################################
  # Lint and formatting checks (runs on all platforms with available features)
  ################################################################################
  lint:
    name: "Lint & Format"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "lint"
          cache-on-failure: true

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy (no native dependencies - works everywhere)
        run: cargo clippy --all-targets --no-default-features --features pgp,license -- -D warnings -W clippy::pedantic

      - name: Run tests (no native dependencies)
        run: cargo test --all-targets --no-default-features --features pgp,license --locked

  ################################################################################
  # Arch Linux build
  ################################################################################
  arch:
    name: "Arch Linux"
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Install system dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm \
            base-devel \
            git \
            rust \
            cargo \
            pkgconf \
            openssl \
            libarchive \
            clang \
            cmake \
            sccache

      - uses: actions/checkout@v4

      - name: Fix git permissions
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.7
        continue-on-error: true

      - name: Configure sccache
        run: |
          if command -v sccache &> /dev/null && sccache --start-server 2>/dev/null; then
            echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
            echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
            echo "::notice::sccache enabled"
          else
            echo "::warning::sccache unavailable, building without cache"
          fi

      - name: Get rust version
        id: rust-version
        run: echo "version=$(rustc --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: arch-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: arch-registry-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: arch-target-${{ steps.rust-version.outputs.version }}-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('src/**/*.rs') }}
          restore-keys: |
            arch-target-${{ steps.rust-version.outputs.version }}-${{ hashFiles('**/Cargo.lock') }}-
            arch-target-${{ steps.rust-version.outputs.version }}-

      - name: Build release binary
        run: cargo build --release --features ${{ env.ARCH_FEATURES }} --locked

      - name: Run clippy
        run: cargo clippy --all-targets --features ${{ env.ARCH_FEATURES }} -- -D warnings -W clippy::pedantic

      - name: Run unit tests
        run: cargo test --lib --features ${{ env.ARCH_FEATURES }} --locked

      - name: Show sccache stats
        run: sccache --show-stats

      - name: Verify binary exists and works
        run: |
          ./target/release/omg --version
          ./target/release/omg --help

  ################################################################################
  # Debian build
  ################################################################################
  debian:
    name: "Debian"
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm

    env:
      DEBIAN_FRONTEND: noninteractive
      CARGO_HOME: /usr/local/cargo
      RUSTUP_HOME: /usr/local/rustup

    steps:
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates \
            curl \
            git \
            build-essential \
            pkg-config \
            libssl-dev \
            libapt-pkg-dev \
            clang \
            cmake \
            zlib1g-dev \
            liblzma-dev \
            libbz2-dev
          rm -rf /var/lib/apt/lists/*

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          echo 'export PATH="$CARGO_HOME/bin:$PATH"' >> $GITHUB_ENV
          echo 'export RUSTUP_HOME="$RUSTUP_HOME"' >> $GITHUB_ENV

      - uses: actions/checkout@v4

      - name: Fix git permissions
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.7
        continue-on-error: true

      - name: Install and configure sccache
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          cargo install sccache --locked || true
          if command -v sccache &> /dev/null && sccache --start-server 2>/dev/null; then
            echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
            echo "RUSTC_WRAPPER=$CARGO_HOME/bin/sccache" >> $GITHUB_ENV
            echo "::notice::sccache enabled"
          else
            echo "::warning::sccache unavailable, building without cache"
          fi

      - name: Get rust version
        id: rust-version
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          echo "version=$(rustc --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/cargo/registry/index/
            /usr/local/cargo/registry/cache/
            /usr/local/cargo/git/db/
          key: debian-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: debian-registry-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: debian-target-${{ steps.rust-version.outputs.version }}-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('src/**/*.rs') }}
          restore-keys: |
            debian-target-${{ steps.rust-version.outputs.version }}-${{ hashFiles('**/Cargo.lock') }}-
            debian-target-${{ steps.rust-version.outputs.version }}-

      - name: Build release binary
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          cargo build --release --no-default-features --features ${{ env.DEBIAN_FEATURES }} --locked

      - name: Run clippy
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          cargo clippy --all-targets --no-default-features --features ${{ env.DEBIAN_FEATURES }} -- -D warnings -W clippy::pedantic

      - name: Run unit tests
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          cargo test --lib --no-default-features --features ${{ env.DEBIAN_FEATURES }} --locked

      - name: Show sccache stats
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          sccache --show-stats

      - name: Verify binary exists and works
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          ./target/release/omg --version
          ./target/release/omg --help

  ################################################################################
  # Ubuntu build
  ################################################################################
  ubuntu:
    name: "Ubuntu"
    runs-on: ubuntu-latest
    container:
      image: ubuntu:latest

    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates \
            curl \
            git \
            build-essential \
            pkg-config \
            libssl-dev \
            libapt-pkg-dev \
            clang \
            cmake
          rm -rf /var/lib/apt/lists/*

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $GITHUB_ENV
          echo 'export CARGO_HOME="$HOME/.cargo"' >> $GITHUB_ENV
          echo 'export RUSTUP_HOME="$HOME/.rustup"' >> $GITHUB_ENV

      - name: Fix git permissions
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.7
        continue-on-error: true

      - name: Install and configure sccache
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          cargo install sccache --locked || true
          if command -v sccache &> /dev/null && sccache --start-server 2>/dev/null; then
            echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
            echo "RUSTC_WRAPPER=$HOME/.cargo/bin/sccache" >> $GITHUB_ENV
            echo "::notice::sccache enabled"
          else
            echo "::warning::sccache unavailable, building without cache"
          fi

      - name: Get rust version
        id: rust-version
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          echo "version=$(rustc --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ubuntu-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ubuntu-registry-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ubuntu-target-${{ steps.rust-version.outputs.version }}-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('src/**/*.rs') }}
          restore-keys: |
            ubuntu-target-${{ steps.rust-version.outputs.version }}-${{ hashFiles('**/Cargo.lock') }}-
            ubuntu-target-${{ steps.rust-version.outputs.version }}-

      - name: Build release binary
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          cargo build --release --no-default-features --features ${{ env.DEBIAN_FEATURES }} --locked

      - name: Run clippy
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          cargo clippy --all-targets --no-default-features --features ${{ env.DEBIAN_FEATURES }} -- -D warnings -W clippy::pedantic

      - name: Run unit tests
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          cargo test --lib --no-default-features --features ${{ env.DEBIAN_FEATURES }} --locked

      - name: Show sccache stats
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          sccache --show-stats

      - name: Verify binary exists and works
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          ./target/release/omg --version
          ./target/release/omg --help

  ################################################################################
  # Success check
  ################################################################################
  check-success:
    name: "CI Status"
    runs-on: ubuntu-latest
    needs: [lint, arch, debian, ubuntu]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Arch: ${{ needs.arch.result }}"
          echo "Debian: ${{ needs.debian.result }}"
          echo "Ubuntu: ${{ needs.ubuntu.result }}"

          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.arch.result }}" != "success" ]] || \
             [[ "${{ needs.debian.result }}" != "success" ]] || \
             [[ "${{ needs.ubuntu.result }}" != "success" ]]; then
            echo "::error::One or more jobs failed"
            exit 1
          fi

          echo "::notice::All CI jobs passed successfully!"
