name: Release

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: release
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  # ════════════════════════════════════════════════════════════════════════════
  # BUILD RELEASE ARTIFACTS
  # ════════════════════════════════════════════════════════════════════════════

  build-arch:
    name: "Build Arch"
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rust cargo pkgconf openssl libarchive clang

      - uses: actions/checkout@v4

      - name: Git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Build
        run: |
          export RUSTFLAGS="-C target-cpu=x86-64-v2"
          cargo build --release

      - name: Package
        run: |
          VERSION=$(awk -F'"' '/^version =/ {print $2; exit}' Cargo.toml)
          mkdir -p "omg-v${VERSION}-x86_64-linux-arch"
          cp target/release/omg "omg-v${VERSION}-x86_64-linux-arch/"
          cp target/release/omgd "omg-v${VERSION}-x86_64-linux-arch/" 2>/dev/null || true
          cp target/release/omg-fast "omg-v${VERSION}-x86_64-linux-arch/" 2>/dev/null || true
          cp README.md LICENSE "omg-v${VERSION}-x86_64-linux-arch/"
          tar -czvf "omg-v${VERSION}-x86_64-linux-arch.tar.gz" "omg-v${VERSION}-x86_64-linux-arch"
          sha256sum "omg-v${VERSION}-x86_64-linux-arch.tar.gz" > "omg-v${VERSION}-x86_64-linux-arch.tar.gz.sha256"

      - uses: actions/upload-artifact@v4
        with:
          name: arch-build
          path: omg-v*.tar.gz*

  build-debian:
    name: "Build Debian"
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
      options: --user root
    env:
      HOME: /root
      CARGO_HOME: /root/.cargo
    steps:
      - name: Install Dependencies
        run: |
          apt-get update
          apt-get install -y curl git build-essential pkg-config libssl-dev libapt-pkg-dev clang cmake

      - uses: actions/checkout@v4

      - name: Git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Install Rust
        run: |
          curl -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --profile minimal
          echo "/root/.cargo/bin" >> $GITHUB_PATH

      - name: Build
        run: |
          . /root/.cargo/env
          cargo build --release --no-default-features --features debian

      - name: Package
        run: |
          VERSION=$(awk -F'"' '/^version =/ {print $2; exit}' Cargo.toml)
          mkdir -p "omg-v${VERSION}-x86_64-linux-debian"
          cp target/release/omg "omg-v${VERSION}-x86_64-linux-debian/"
          cp target/release/omgd "omg-v${VERSION}-x86_64-linux-debian/" 2>/dev/null || true
          cp README.md LICENSE "omg-v${VERSION}-x86_64-linux-debian/"
          tar -czvf "omg-v${VERSION}-x86_64-linux-debian.tar.gz" "omg-v${VERSION}-x86_64-linux-debian"
          sha256sum "omg-v${VERSION}-x86_64-linux-debian.tar.gz" > "omg-v${VERSION}-x86_64-linux-debian.tar.gz.sha256"

      - uses: actions/upload-artifact@v4
        with:
          name: debian-build
          path: omg-v*.tar.gz*

  # ════════════════════════════════════════════════════════════════════════════
  # PUBLISH RELEASE
  # ════════════════════════════════════════════════════════════════════════════

  release:
    name: "Create Release"
    runs-on: ubuntu-latest
    needs: [build-arch, build-debian]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect Files
        run: |
          mkdir release
          find artifacts -name "*.tar.gz*" -exec cp {} release/ \;
          ls -la release/

      - uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
