name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (do not publish)'
        required: false
        default: 'true'

concurrency:
  group: release
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  # ════════════════════════════════════════════════════════════════════════════
  # BUILD RELEASE ARTIFACTS
  # ════════════════════════════════════════════════════════════════════════════

  build-arch:
    name: "Build Arch"
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rust cargo pkgconf openssl libarchive clang

      - uses: actions/checkout@v4

      - name: Git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Build
        run: |
          export RUSTFLAGS="-C target-cpu=x86-64-v2"
          cargo build --release --features arch

      - name: Package
        run: |
          VERSION=$(awk -F'"' '/^version =/ {print $2; exit}' Cargo.toml)
          mkdir -p "omg-v${VERSION}-x86_64-linux-arch"
          cp target/release/omg "omg-v${VERSION}-x86_64-linux-arch/"
          cp target/release/omgd "omg-v${VERSION}-x86_64-linux-arch/" 2>/dev/null || true
          cp README.md LICENSE "omg-v${VERSION}-x86_64-linux-arch/"
          tar -czvf "omg-v${VERSION}-x86_64-linux-arch.tar.gz" "omg-v${VERSION}-x86_64-linux-arch"
          sha256sum "omg-v${VERSION}-x86_64-linux-arch.tar.gz" > "omg-v${VERSION}-x86_64-linux-arch.tar.gz.sha256"

      - uses: actions/upload-artifact@v4
        with:
          name: arch-build
          path: omg-v*.tar.gz*

  build-debian:
    name: "Build Debian"
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
    env:
      DEBIAN_FRONTEND: noninteractive
      CARGO_HOME: /usr/local/cargo
      RUSTUP_HOME: /usr/local/rustup
    steps:
      - name: Install Dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates \
            curl \
            git \
            build-essential \
            pkg-config \
            libssl-dev \
            libapt-pkg-dev \
            clang \
            cmake
          rm -rf /var/lib/apt/lists/*

      - uses: actions/checkout@v4

      - name: Git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          echo 'export PATH="$CARGO_HOME/bin:$PATH"' >> $GITHUB_ENV

      - name: Build
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          cargo build --release --no-default-features --features debian

      - name: Package
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          VERSION=$(awk -F'"' '/^version =/ {print $2; exit}' Cargo.toml)
          mkdir -p "omg-v${VERSION}-x86_64-linux-debian"
          cp target/release/omg "omg-v${VERSION}-x86_64-linux-debian/"
          cp README.md LICENSE "omg-v${VERSION}-x86_64-linux-debian/"
          tar -czvf "omg-v${VERSION}-x86_64-linux-debian.tar.gz" "omg-v${VERSION}-x86_64-linux-debian"
          sha256sum "omg-v${VERSION}-x86_64-linux-debian.tar.gz" > "omg-v${VERSION}-x86_64-linux-debian.tar.gz.sha256"

      - uses: actions/upload-artifact@v4
        with:
          name: debian-build
          path: omg-v*.tar.gz*

  build-ubuntu:
    name: "Build Ubuntu"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libapt-pkg-dev \
            pkg-config \
            libssl-dev \
            clang \
            cmake

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build
        run: cargo build --release --no-default-features --features debian

      - name: Package
        run: |
          VERSION=$(awk -F'"' '/^version =/ {print $2; exit}' Cargo.toml)
          mkdir -p "omg-v${VERSION}-x86_64-linux-ubuntu"
          cp target/release/omg "omg-v${VERSION}-x86_64-linux-ubuntu/"
          cp README.md LICENSE "omg-v${VERSION}-x86_64-linux-ubuntu/"
          tar -czvf "omg-v${VERSION}-x86_64-linux-ubuntu.tar.gz" "omg-v${VERSION}-x86_64-linux-ubuntu"
          sha256sum "omg-v${VERSION}-x86_64-linux-ubuntu.tar.gz" > "omg-v${VERSION}-x86_64-linux-ubuntu.tar.gz.sha256"

      - uses: actions/upload-artifact@v4
        with:
          name: ubuntu-build
          path: omg-v*.tar.gz*

  # ════════════════════════════════════════════════════════════════════════════
  # PUBLISH RELEASE
  # ════════════════════════════════════════════════════════════════════════════

  release:
    name: "Create Release"
    runs-on: ubuntu-latest
    needs: [build-arch, build-debian, build-ubuntu]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect Files
        run: |
          mkdir release
          find artifacts -name "*.tar.gz*" -exec cp {} release/ \;
          ls -la release/

      - name: Generate Release Notes
        id: release_notes
        run: |
          echo "## OMG v${{ github.ref_name }}" > release_notes.md
          echo "" >> release_notes.md
          echo "### Downloads" >> release_notes.md
          echo "" >> release_notes.md
          echo "- **Arch Linux**: \`omg-*-x86_64-linux-arch.tar.gz\`" >> release_notes.md
          echo "- **Debian**: \`omg-*-x86_64-linux-debian.tar.gz\`" >> release_notes.md
          echo "- **Ubuntu**: \`omg-*-x86_64-linux-ubuntu.tar.gz\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "tar -xzf omg-*-x86_64-linux-*.tar.gz" >> release_notes.md
          echo "cd omg-*-x86_64-linux-*" >> release_notes.md
          echo "sudo cp omg /usr/local/bin/" >> release_notes.md
          echo "\`\`\`" >> release_notes.md

      - uses: softprops/action-gh-release@v2
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'false')
        with:
          body_path: release_notes.md
          files: release/*
          generate_release_notes: false
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
