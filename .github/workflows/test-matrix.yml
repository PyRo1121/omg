name: Test Matrix

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # Lint checks for each platform
  # ═══════════════════════════════════════════════════════════════════════════
  lint-arch:
    name: Lint (Arch)
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rust cargo clang cmake
      - name: Check formatting
        run: cargo fmt -- --check
      - name: Clippy (Arch)
        run: cargo clippy --all-targets --features arch -- -D warnings -W clippy::pedantic

  lint-debian:
    name: Lint (Debian)
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
    env:
      CARGO_HOME: /usr/local/cargo
      RUSTUP_HOME: /usr/local/rustup
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y build-essential curl git pkg-config libssl-dev libapt-pkg-dev clang cmake
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          rm -rf /var/lib/apt/lists/*
      - name: Clippy (Debian)
        run: |
          export PATH="$CARGO_HOME/bin:$PATH"
          cargo clippy --all-targets --no-default-features --features debian -- -D warnings -W clippy::pedantic

  # ═══════════════════════════════════════════════════════════════════════════
  # Test matrix for all distros
  # ═══════════════════════════════════════════════════════════════════════════
  test-matrix:
    name: Tests (${{ matrix.distro }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        distro: [arch, debian, ubuntu]
    container:
      image: ${{ matrix.distro == 'arch' && 'archlinux:latest' || (matrix.distro == 'debian' && 'debian:bookworm' || 'ubuntu:latest') }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Arch)
        if: matrix.distro == 'arch'
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rust cargo clang cmake

      - name: Install dependencies (Debian/Ubuntu)
        if: matrix.distro != 'arch'
        run: |
          apt-get update
          apt-get install -y build-essential curl git pkg-config libssl-dev libapt-pkg-dev clang cmake
          rm -rf /var/lib/apt/lists/*
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

      - name: Run unit tests
        run: |
          if [ "${{ matrix.distro }}" != "arch" ]; then export PATH="$HOME/.cargo/bin:$PATH"; fi
          FEATURES="${{ matrix.distro == 'arch' && 'arch' || 'debian' }}"
          cargo test --lib --no-default-features --features "$FEATURES"

      - name: Run doc tests
        run: |
          if [ "${{ matrix.distro }}" != "arch" ]; then export PATH="$HOME/.cargo/bin:$PATH"; fi
          FEATURES="${{ matrix.distro == 'arch' && 'arch' || 'debian' }}"
          cargo test --doc --no-default-features --features "$FEATURES"

  # ═══════════════════════════════════════════════════════════════════════════
  # Integration tests (Arch only - most complete)
  # ═══════════════════════════════════════════════════════════════════════════
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rust cargo clang cmake
      - name: Run integration tests
        run: |
          cargo test --test integration_suite --features arch
          cargo test --test exhaustive_cli_matrix --features arch

  # ═══════════════════════════════════════════════════════════════════════════
  # Final status check
  # ═══════════════════════════════════════════════════════════════════════════
  test-status:
    name: "Test Status"
    needs: [lint-arch, lint-debian, test-matrix, integration-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          echo "Lint Arch: ${{ needs.lint-arch.result }}"
          echo "Lint Debian: ${{ needs.lint-debian.result }}"
          echo "Test Matrix: ${{ needs.test-matrix.result }}"
          echo "Integration: ${{ needs.integration-tests.result }}"

          if [[ "${{ needs.lint-arch.result }}" != "success" ]] || \
             [[ "${{ needs.lint-debian.result }}" != "success" ]] || \
             [[ "${{ needs.test-matrix.result }}" != "success" ]] || \
             [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
            echo "::error::One or more test jobs failed"
            exit 1
          fi

          echo "::notice::All test jobs passed successfully!"
