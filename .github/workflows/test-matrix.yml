name: Multi-Distro Test Matrix

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_destructive:
        description: 'Run destructive tests'
        type: boolean
        default: false
      run_stress:
        description: 'Run stress tests'
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # UNIT TESTS (Arch container - code requires arch features)
  # ═══════════════════════════════════════════════════════════════════════════
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rustup clang
          rustup default stable
        
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        
      - name: Run unit tests
        run: cargo test --lib --features arch

  # ═══════════════════════════════════════════════════════════════════════════
  # ARCH LINUX TESTS
  # ═══════════════════════════════════════════════════════════════════════════
  arch-tests:
    name: Arch Linux Tests
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rustup clang
          rustup default stable
          
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        
      - name: Build with Arch feature
        run: cargo build --features arch
        
      - name: Run Arch integration tests
        env:
          OMG_RUN_SYSTEM_TESTS: "1"
          OMG_TEST_DISTRO: "arch"
        run: cargo test --test arch_tests --features arch
        
      - name: Run integration suite
        env:
          OMG_RUN_SYSTEM_TESTS: "1"
        run: cargo test --test integration_suite --features arch

  # ═══════════════════════════════════════════════════════════════════════════
  # DEBIAN TESTS
  # ═══════════════════════════════════════════════════════════════════════════
  debian-tests:
    name: Debian Tests
    runs-on: ubuntu-latest
    continue-on-error: true  # Debian feature has complex deps, non-blocking
    container:
      image: debian:bookworm
      options: --privileged
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y build-essential curl git pkg-config libssl-dev libapt-pkg-dev clang cmake zlib1g-dev
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          . $HOME/.cargo/env
          
      - name: Build with Debian feature
        run: |
          . $HOME/.cargo/env
          cargo build --features debian
          
      - name: Run Debian integration tests
        env:
          OMG_RUN_SYSTEM_TESTS: "1"
          OMG_TEST_DISTRO: "debian"
        run: |
          . $HOME/.cargo/env
          cargo test --test debian_tests --features debian

  # ═══════════════════════════════════════════════════════════════════════════
  # UBUNTU TESTS (Multiple versions)
  # ═══════════════════════════════════════════════════════════════════════════
  ubuntu-tests:
    name: Ubuntu ${{ matrix.ubuntu }} Tests
    runs-on: ubuntu-latest
    continue-on-error: true  # Debian feature has complex deps, non-blocking
    strategy:
      fail-fast: false
      matrix:
        ubuntu: ['22.04', '24.04']
    container:
      image: ubuntu:${{ matrix.ubuntu }}
      options: --privileged
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y build-essential curl git pkg-config libssl-dev libapt-pkg-dev clang cmake zlib1g-dev
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          . $HOME/.cargo/env
          
      - name: Build with Debian feature
        run: |
          . $HOME/.cargo/env
          cargo build --features debian
          
      - name: Run Ubuntu integration tests
        env:
          OMG_RUN_SYSTEM_TESTS: "1"
          OMG_TEST_DISTRO: "ubuntu"
        run: |
          . $HOME/.cargo/env
          cargo test --test debian_tests --features debian

  # ═══════════════════════════════════════════════════════════════════════════
  # PROPERTY-BASED TESTS
  # ═══════════════════════════════════════════════════════════════════════════
  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rustup clang
          rustup default stable
        
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        
      - name: Run property tests
        run: cargo test --test property_tests --features arch -- --test-threads=1
        timeout-minutes: 10
        env:
          PROPTEST_CASES: 20

  # ═══════════════════════════════════════════════════════════════════════════
  # SECURITY TESTS
  # ═══════════════════════════════════════════════════════════════════════════
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rustup clang
          rustup default stable
        
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        
      - name: Run security tests
        run: cargo test --test security_tests --features arch
        
      - name: Security audit
        run: |
          cargo install cargo-audit
          cargo audit

  # ═══════════════════════════════════════════════════════════════════════════
  # PERFORMANCE TESTS
  # ═══════════════════════════════════════════════════════════════════════════
  perf-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    continue-on-error: true  # Performance thresholds may vary in CI
    container:
      image: archlinux:latest
      options: --privileged
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rustup clang
          rustup default stable
          
      - name: Build release
        run: cargo build --release --features arch
        
      - name: Run performance tests
        env:
          OMG_RUN_PERF_TESTS: "1"
          OMG_RUN_SYSTEM_TESTS: "1"
        run: cargo test --test arch_tests --features arch -- performance

  # ═══════════════════════════════════════════════════════════════════════════
  # STRESS TESTS (Manual trigger only)
  # ═══════════════════════════════════════════════════════════════════════════
  stress-tests:
    name: Stress Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.run_stress == 'true' }}
    container:
      image: archlinux:latest
      options: --privileged
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rustup clang
          rustup default stable
          
      - name: Build release
        run: cargo build --release --features arch
        
      - name: Run stress tests
        env:
          OMG_RUN_STRESS_TESTS: "1"
          OMG_RUN_SYSTEM_TESTS: "1"
        run: cargo test --test property_tests --features arch -- --ignored

  # ═══════════════════════════════════════════════════════════════════════════
  # FUZZ TESTS (Manual trigger only)
  # ═══════════════════════════════════════════════════════════════════════════
  fuzz-tests:
    name: Fuzz Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.run_destructive == 'true' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        
      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz
        
      - name: Run fuzz tests (5 min)
        run: |
          cargo +nightly fuzz run fuzz_cli -- -max_total_time=300 || true

  # ═══════════════════════════════════════════════════════════════════════════
  # CLIPPY AND FORMAT CHECK
  # ═══════════════════════════════════════════════════════════════════════════
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rustup clang
          rustup default stable
          rustup component add rustfmt clippy
          
      - name: Check formatting
        run: cargo fmt -- --check
        
      - name: Clippy (Arch)
        run: cargo clippy --features arch -- -D warnings

  # ═══════════════════════════════════════════════════════════════════════════
  # DOCUMENTATION TESTS
  # ═══════════════════════════════════════════════════════════════════════════
  doc-tests:
    name: Documentation Tests
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rustup clang
          rustup default stable
        
      - name: Run doc tests
        run: cargo test --doc --features arch
        
      - name: Build docs
        run: cargo doc --features arch --no-deps

  # ═══════════════════════════════════════════════════════════════════════════
  # COVERAGE REPORT
  # ═══════════════════════════════════════════════════════════════════════════
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git rustup llvm clang
          rustup default stable
          rustup component add llvm-tools-preview
          cargo install cargo-llvm-cov
          
      - name: Generate coverage
        env:
          OMG_RUN_SYSTEM_TESTS: "1"
        run: |
          cargo llvm-cov --features arch --lcov --output-path lcov.info
          
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false

  # ═══════════════════════════════════════════════════════════════════════════
  # FINAL STATUS CHECK
  # ═══════════════════════════════════════════════════════════════════════════
  test-status:
    name: All Tests Passed
    needs: [unit-tests, arch-tests, property-tests, security-tests, lint, doc-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check core tests
        run: |
          echo "Core test results:"
          echo "  unit-tests: ${{ needs.unit-tests.result }}"
          echo "  arch-tests: ${{ needs.arch-tests.result }}"
          echo "  property-tests: ${{ needs.property-tests.result }}"
          echo "  security-tests: ${{ needs.security-tests.result }}"
          echo "  lint: ${{ needs.lint.result }}"
          echo "  doc-tests: ${{ needs.doc-tests.result }}"
          if [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.doc-tests.result }}" != "success" ]]; then
            echo "❌ Core tests failed"
            exit 1
          fi
          echo "✅ Core tests passed!"
