# Phase 3: Architecture Audit

**Date:** 2026-01-26
**Phase:** 3 - Architecture & Consistency
**Status:** Complete

## Module Structure

```
src/
├── bin/                   # 4 files (omg, omgd, omg-fast, perf_audit)
├── cli/                   # 59 files - CLI commands and UI (TEA framework)
│   ├── packages/          # Package management commands (12 files)
│   ├── tea/               # Elm Architecture framework (11 files)
│   ├── tui/               # Terminal UI (3 files)
│   └── components/        # Reusable UI components (1 file)
├── config/                # 2 files - Configuration management
├── core/                  # 41 files - Core business logic
│   ├── env/               # Environment detection (4 files)
│   ├── packages/          # Package service (2 files)
│   ├── security/          # Security features (9 files)
│   └── testing/           # Test utilities (4 files)
├── daemon/                # 8 files - Background daemon
├── hooks/                 # 2 files - Shell hooks and completions
├── lib/                   # 1 file - Progress utilities
├── package_managers/      # 17 files - Package manager backends
├── runtimes/              # 11 files - Language runtime managers
└── shims/                 # 2 files - Shim generation
```

**Total:** 49,254 lines of Rust across 148 files

## Over-Engineering Patterns

### 1. Traits with Single Implementation

#### RuntimeManager Trait - ZERO Implementations (Priority: HIGH)

**Location:** `src/runtimes/manager.rs:8`

```rust
pub trait RuntimeManager: Send + Sync {
    fn runtime(&self) -> Runtime;
    fn list_available(&self) -> impl Future<Output = Result<Vec<String>>> + Send;
    fn list_installed(&self) -> Result<Vec<RuntimeVersion>>;
    fn install(&self, version: &str) -> impl Future<Output = Result<()>> + Send;
    fn uninstall(&self, version: &str) -> Result<()>;
    fn active_version(&self) -> Result<Option<String>>;
    fn set_active(&self, version: &str) -> Result<()>;
    fn version_bin_path(&self, version: &str) -> Result<std::path::PathBuf>;
}
```

**Implementations Found:** 0 (ZERO!)

**Concrete Structs (NOT implementing the trait):**
- NodeManager (src/runtimes/node.rs:34)
- PythonManager (src/runtimes/python.rs:46)
- RustManager (src/runtimes/rust.rs:99)
- GoManager (src/runtimes/go.rs:32)
- JavaManager (src/runtimes/java.rs:42)
- BunManager (src/runtimes/bun.rs:38)
- RubyManager (src/runtimes/ruby.rs:37)
- MiseManager (src/runtimes/mise.rs:28)

**Recommendation:** DELETE - The trait is pure dead code. All runtime managers are used as concrete types.

#### PrivilegeChecker Trait - 2 Implementations (Priority: LOW)

**Location:** `src/core/privilege.rs:28`

**Implementations:**
1. SystemPrivilegeChecker (production)
2. MockPrivilegeChecker (tests only)

**Recommendation:** KEEP - This is proper dependency injection for testing.

#### PackageManager Trait - 4 Implementations (Priority: MEDIUM)

**Location:** `src/package_managers/traits.rs:18`

**Implementations:**
1. ArchPackageManager (production)
2. PureDebianPackageManager (production)
3. TestPackageManager (tests)
4. MockPackageManager (tests)

**Recommendation:** KEEP - Two real implementations suggest legitimate polymorphism for multi-distro support.

#### LocalCommandRunner Trait - 9 Implementations (Priority: LOW)

**Location:** `src/cli/mod.rs:68`

Generated by `trait_variant::make` for async command pattern.

**Implementations:** Commands, ToolCommands, TeamCommands, FleetCommands, EnvCommands, EnterpriseCommands, ContainerCommands, AuditCommands, RunCommand

**Recommendation:** KEEP - Well-designed async command pattern with multiple implementations.

#### Model/Msg Traits - 9+ Implementations (Priority: LOW)

**Location:** `src/cli/tea/mod.rs:119`

TEA (The Elm Architecture) framework traits.

**Implementations:** InstallModel, StatusModel, SearchModel, RemoveModel, UpdateModel, InfoModel, CounterModel, and more

**Recommendation:** KEEP - Proper architectural pattern with multiple implementations.

### 2. Excessive Generics

#### Components Module - 23 Over-Generic Functions (Priority: HIGH)

**Location:** `src/cli/components/mod.rs`

Every function has a generic `<M>` parameter that serves no purpose except type inference:

```rust
pub fn header<M>(title: impl Into<String>, body: impl Into<String>) -> Cmd<M>
pub fn success<M>(message: impl Into<String>) -> Cmd<M>
pub fn error<M>(message: impl Into<String>) -> Cmd<M>
pub fn warning<M>(message: impl Into<String>) -> Cmd<M>
pub fn info<M>(message: impl Into<String>) -> Cmd<M>
pub fn card<M>(title: impl Into<String>, content: Vec<String>) -> Cmd<M>
pub fn spacer<M>() -> Cmd<M>
pub fn bold<M>(text: impl Into<String>) -> Cmd<M>
pub fn muted<M>(text: impl Into<String>) -> Cmd<M>
pub fn step<M>(step: usize, total: usize, message: impl Into<String>) -> Cmd<M>
pub fn package_list<M>(...) -> Cmd<M>
pub fn update_summary<M>(...) -> Cmd<M>
pub fn kv_list<M>(...) -> Cmd<M>
pub fn status_summary<M>(...) -> Cmd<M>
pub fn loading<M>(message: impl Into<String>) -> Cmd<M>
pub fn no_results<M>(query: impl Into<String>) -> Cmd<M>
pub fn up_to_date<M>() -> Cmd<M>
pub fn permission_error<M>(command: impl Into<String>) -> Cmd<M>
pub fn confirm<M>(message: impl Into<String>, action: impl Into<String>) -> Cmd<M>
pub fn complete<M>(message: impl Into<String>) -> Cmd<M>
pub fn error_with_suggestion<M>(...) -> Cmd<M>
pub fn welcome<M>(command: &str, description: &str) -> Cmd<M>
pub fn section<M>(title: impl Into<String>) -> Cmd<M>
// ... 23 total functions
```

**Problem:** The generic `M` is only used in the return type `Cmd<M>`. Functions don't constrain `M` in any way - they work with ANY type.

**Impact:**
- Mental overhead when reading code
- No actual polymorphism benefit
- Visual noise in 23 function signatures
- Over-abstraction for type inference convenience

**Recommendation:** Simplify - Either make `Cmd` non-generic or create a `Components<M>` struct to hold the generic once.

#### Helper Function Generics (Priority: LOW)

**Locations:**
- `src/core/task_runner.rs:570` - `run_async<F, T>`
- `src/core/testing/helpers.rs:95` - `with_timeout<F, T>`
- `src/core/testing/helpers.rs:105` - `retry<F, T, E>`

**Recommendation:** KEEP - These are proper generic utilities that work with any future/closure type.

### 3. Unnecessary Abstraction Layers

No significant unnecessary abstraction layers found beyond the RuntimeManager trait.

Most traits have legitimate use cases:
- Testing abstractions (PrivilegeChecker, MockPackageManager)
- Multi-implementation patterns (PackageManager, LocalCommandRunner, Model)
- Framework patterns (TEA's Model/Msg traits)

## Module Reorganization Needed

Current structure is technical rather than domain-oriented:
```
cli/              - Technical layer (UI)
core/             - Grab-bag of utilities
package_managers/ - Backends
runtimes/         - Backends
```

**Recommended DDD Structure:**
```
domain/
  packages/       - Package domain entities and services
  runtimes/       - Runtime domain
  security/       - Security domain

infrastructure/
  alpm/           - ALPM backend
  apt/            - APT backend
  http/           - HTTP client

application/
  cli/            - CLI interface
  daemon/         - Background service

shared/
  error/          - Error types
  config/         - Configuration
```

**Note:** This is a major refactor - recommend deferring to post-Phase 3.

## Priority Summary

### High Priority (2 items)
1. RuntimeManager trait - ZERO implementations, pure dead code
2. Components module - 23 functions with unnecessary `<M>` generic

### Medium Priority (1 item)
3. PackageManager trait - Only 2 real implementations (borderline, keep for now)

### Low Priority (4 items)
4. PrivilegeChecker trait - Proper DI pattern (keep)
5. LocalCommandRunner trait - 9 implementations (keep)
6. Model/Msg traits - 9+ implementations (keep)
7. Helper function generics - Proper generic utilities (keep)

**Action Items for Phase 3:**
- Task 2: Remove RuntimeManager trait
- Task 3: Simplify Components module generics
